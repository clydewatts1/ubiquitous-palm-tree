name: Copilot Agent Workflow

on:
  issues:
    types: [labeled]
  pull_request:
    types: [opened, synchronize]

jobs:
  copilot-agent-task:
    if: github.event.label.name == 'copilot-agent' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run validation checks
      run: |
        # Run tests to validate agent changes
        pytest tests/ -v
        
        # Check code quality
        black --check src/ tests/ || echo "Formatting issues detected"
        flake8 src/ tests/ || echo "Linting issues detected"
    
    - name: Comment on issue or PR
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const output = `#### Copilot Agent Validation
          - Tests: ${{ job.status }}
          - Code Quality: Checked
          
          *Triggered by GitHub Copilot Agent workflow*`;
          
          if (context.eventName === 'issues') {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
          } else if (context.eventName === 'pull_request') {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
          }
